# CLAUDE.md

This file provides guidance to Claude Code when working with the homebrew-mcpx tap repository.

## Repository Overview

This is a Homebrew tap repository for [mcpx](https://github.com/AIGC-Hackers/mcpx), an extended TypeScript runtime and CLI for the Model Context Protocol. The tap enables users to install mcpx via `brew install AIGC-Hackers/mcpx/mcpx`.

## Critical Rules

### ðŸš¨ DO NOT Manually Edit Formula/mcpx.rb

**The formula file is auto-generated by CI workflows.** Manual edits will be overwritten.

The correct workflow is:

1. **Release in main repo**: Push a version tag to `AIGC-Hackers/mcpx` (e.g., `git tag v0.5.0 && git push origin v0.5.0`)
2. **Automatic build**: The [release.yml](https://github.com/AIGC-Hackers/mcpx/blob/main/.github/workflows/release.yml) workflow in the main repo:
   - Builds binaries for all platforms (darwin-arm64, linux-arm64, linux-x64)
   - Creates a GitHub Release with all artifacts
3. **Automatic formula update**: The [update-homebrew.yml](https://github.com/AIGC-Hackers/mcpx/blob/main/.github/workflows/update-homebrew.yml) workflow:
   - Triggers on release publication OR manual dispatch
   - Downloads all release binaries from GitHub
   - Calculates SHA256 checksums
   - **Regenerates Formula/mcpx.rb from scratch**
   - Commits and pushes to this repo

### How to Update Formula

**Option 1: Automatic (Recommended)**
- Tag and push a new version in the main mcpx repo
- The release and update-homebrew workflows run automatically
- Formula updates within minutes

**Option 2: Manual Trigger**
```bash
# Trigger the update-homebrew workflow manually
gh workflow run update-homebrew.yml --repo AIGC-Hackers/mcpx --field version=0.5.0

# Watch progress
gh run list --repo AIGC-Hackers/mcpx --workflow=update-homebrew.yml --limit 1
```

**Option 3: Local Script (Fallback)**
```bash
# Only use if CI is broken
./update-formula.sh 0.5.0

# Then commit manually
git add Formula/mcpx.rb
git commit -m "chore: update to v0.5.0"
git push
```

## Repository Structure

```
homebrew-mcpx/
â”œâ”€â”€ Formula/
â”‚   â””â”€â”€ mcpx.rb          # Auto-generated Homebrew formula (DO NOT EDIT)
â”œâ”€â”€ update-formula.sh     # Local tool for manual updates
â”œâ”€â”€ README.md            # User-facing installation instructions
â””â”€â”€ CLAUDE.md            # This file (context for Claude Code)
```

## Common Tasks

### Check Current Formula Version
```bash
cat Formula/mcpx.rb | grep 'version "'
```

### Verify Installed Version
```bash
brew info mcpx
mcpx --version
```

### Test Formula Locally
```bash
brew reinstall mcpx
brew test mcpx
```

### Sync Local Repo with Remote
```bash
git fetch origin
git reset --hard origin/main  # Discard any local edits
```

## Troubleshooting

### Formula SHA256 Mismatch
This happens when:
- Binaries were manually edited in Formula/mcpx.rb
- Release assets were replaced after formula update
- Local cache is stale

**Fix:**
```bash
# Re-trigger the CI workflow to regenerate formula
gh workflow run update-homebrew.yml --repo AIGC-Hackers/mcpx --field version=<current-version>

# Wait for completion
gh run watch <run-id> --repo AIGC-Hackers/mcpx

# Pull updated formula
git pull
```

### Release Exists But Formula Not Updated
Check workflow status:
```bash
gh run list --repo AIGC-Hackers/mcpx --workflow=update-homebrew.yml --limit 3
```

If workflow succeeded but formula is old:
```bash
git pull  # You may have stale local state
```

If workflow failed:
```bash
gh run view <run-id> --repo AIGC-Hackers/mcpx --log
```

## Integration with Main Repo

This tap is tightly coupled with the main [AIGC-Hackers/mcpx](https://github.com/AIGC-Hackers/mcpx) repository:

- **Source of truth**: GitHub Releases in the main repo
- **Update trigger**: Release publication OR manual workflow dispatch
- **Authentication**: Uses `HOMEBREW_TAP_TOKEN` secret for write access to this repo

The update-homebrew.yml workflow in the main repo has permissions to push to this tap automatically.

## Manual Formula Updates (Emergency Only)

If CI is completely broken and you need to update manually:

1. **Download binaries** from the GitHub Release
2. **Calculate SHA256** for all platforms:
   ```bash
   shasum -a 256 mcpx-darwin-arm64
   shasum -a 256 mcpx-linux-arm64
   shasum -a 256 mcpx-linux-x64
   ```
3. **Run update script**:
   ```bash
   ./update-formula.sh <version>
   ```
4. **Verify generated formula** looks correct
5. **Commit and push**:
   ```bash
   git add Formula/mcpx.rb
   git commit -m "chore: update to v<version>"
   git push
   ```

**Important:** After manual updates, document what broke CI and fix it to prevent future manual interventions.

## Philosophy

This repo follows the "generated artifact" pattern:
- Formula/mcpx.rb is a build output, not source code
- CI is the source of truth for formula content
- Manual edits are debugging/emergency actions, not standard workflow
- All changes should trace back to a GitHub Release in the main repo

When working with this repo, think of it as a **distribution mirror**, not a development workspace.
